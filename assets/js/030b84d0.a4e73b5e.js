"use strict";(self.webpackChunkall_in_one_solana=self.webpackChunkall_in_one_solana||[]).push([[5920],{3905:(e,n,t)=>{t.d(n,{Zo:()=>s,kt:()=>m});var a=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function l(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)t=o[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var p=a.createContext({}),c=function(e){var n=a.useContext(p),t=n;return e&&(t="function"==typeof e?e(n):l(l({},n),e)),t},s=function(e){var n=c(e.components);return a.createElement(p.Provider,{value:n},e.children)},u="mdxType",d={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},k=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,o=e.originalType,p=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),u=c(t),k=r,m=u["".concat(p,".").concat(k)]||u[k]||d[k]||o;return t?a.createElement(m,l(l({ref:n},s),{},{components:t})):a.createElement(m,l({ref:n},s))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var o=t.length,l=new Array(o);l[0]=k;var i={};for(var p in n)hasOwnProperty.call(n,p)&&(i[p]=n[p]);i.originalType=e,i[u]="string"==typeof e?e:r,l[1]=i;for(var c=2;c<o;c++)l[c]=t[c];return a.createElement.apply(null,l)}return a.createElement.apply(null,t)}k.displayName="MDXCreateElement"},61751:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>i,toc:()=>c});var a=t(87462),r=(t(67294),t(3905));const o={sidebar_position:91,sidebar_label:"\ud83e\udd69 \u4f7f\u7528Anchor\u8fdb\u884cNFT\u7684\u8d28\u62bc",sidebar_class_name:"green"},l="\ud83e\udd69 \u4f7f\u7528Anchor\u8fdb\u884cNFT\u7684\u8d28\u62bc",i={unversionedId:"module5/a-full-stack-anchor-app/staking-with-anchor/README",id:"module5/a-full-stack-anchor-app/staking-with-anchor/README",title:"\ud83e\udd69 \u4f7f\u7528Anchor\u8fdb\u884cNFT\u7684\u8d28\u62bc",description:"\u73b0\u5728\u662f\u65f6\u5019\u5c06\u4f60\u7684NFT\u8d28\u62bc\u8ba1\u5212\u53ca\u7528\u6237\u754c\u9762\u8fc1\u79fb\u5230Anchor\u4e0a\u4e86\uff01\u4f60\u4e00\u76f4\u8f9b\u82e6\u5f00\u53d1\u7684buildoor\u9879\u76ee\u5df2\u7ecf\u76f8\u5f53\u51fa\u8272\uff0c\u4f46\u5c06\u5176\u8fc1\u79fb\u5230Anchor\u4e0a\u5c06\u4f7f\u672a\u6765\u7684\u5de5\u4f5c\u53d8\u5f97\u66f4\u52a0\u7b80\u6d01\u3002\u8bf7\u5229\u7528\u4f60\u6240\u638c\u63e1\u7684\u77e5\u8bc6\uff0c\u5b8c\u6210\u4e0b\u8ff0\u4efb\u52a1\uff1a",source:"@site/docs/Solana-Co-Learn/module5/a-full-stack-anchor-app/staking-with-anchor/README.md",sourceDirName:"module5/a-full-stack-anchor-app/staking-with-anchor",slug:"/module5/a-full-stack-anchor-app/staking-with-anchor/",permalink:"/Solana-Co-Learn/module5/a-full-stack-anchor-app/staking-with-anchor/",draft:!1,editUrl:"https://github.com/CreatorsDAO/all-in-one-solana/tree/main/docs/Solana-Co-Learn/module5/a-full-stack-anchor-app/staking-with-anchor/README.md",tags:[],version:"current",lastUpdatedBy:"Davirain",lastUpdatedAt:1695967092,formattedLastUpdatedAt:"Sep 29, 2023",sidebarPosition:91,frontMatter:{sidebar_position:91,sidebar_label:"\ud83e\udd69 \u4f7f\u7528Anchor\u8fdb\u884cNFT\u7684\u8d28\u62bc",sidebar_class_name:"green"},sidebar:"tutorialSidebar",previous:{title:"\u4e00\u4e2a\u5168\u6808\u7684Anchor\u5e94\u7528\u7a0b\u5e8f",permalink:"/Solana-Co-Learn/module5/a-full-stack-anchor-app/"},next:{title:"\ud83d\udcb8 \u4f7f\u7528Anchor\u8d4e\u56de",permalink:"/Solana-Co-Learn/module5/a-full-stack-anchor-app/redeeming-with-anchor/"}},p={},c=[],s={toc:c},u="wrapper";function d(e){let{components:n,...t}=e;return(0,r.kt)(u,(0,a.Z)({},s,t,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"-\u4f7f\u7528anchor\u8fdb\u884cnft\u7684\u8d28\u62bc"},"\ud83e\udd69 \u4f7f\u7528Anchor\u8fdb\u884cNFT\u7684\u8d28\u62bc"),(0,r.kt)("p",null,"\u73b0\u5728\u662f\u65f6\u5019\u5c06\u4f60\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"NFT"),"\u8d28\u62bc\u8ba1\u5212\u53ca\u7528\u6237\u754c\u9762\u8fc1\u79fb\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor"),"\u4e0a\u4e86\uff01\u4f60\u4e00\u76f4\u8f9b\u82e6\u5f00\u53d1\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"buildoor"),"\u9879\u76ee\u5df2\u7ecf\u76f8\u5f53\u51fa\u8272\uff0c\u4f46\u5c06\u5176\u8fc1\u79fb\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor"),"\u4e0a\u5c06\u4f7f\u672a\u6765\u7684\u5de5\u4f5c\u53d8\u5f97\u66f4\u52a0\u7b80\u6d01\u3002\u8bf7\u5229\u7528\u4f60\u6240\u638c\u63e1\u7684\u77e5\u8bc6\uff0c\u5b8c\u6210\u4e0b\u8ff0\u4efb\u52a1\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"\u4f7f\u7528",(0,r.kt)("inlineCode",{parentName:"li"},"Anchor"),"\u4ece\u5934\u5f00\u59cb\u91cd\u65b0\u7f16\u5199\u4ee3\u7801\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u589e\u52a0\u4e00\u4e9b\u53ef\u9760\u7684\u6d4b\u8bd5\u8986\u76d6\uff0c\u4ee5\u786e\u4fdd\u4f60\u80fd\u591f\u4e25\u5bc6\u6355\u6349\u4efb\u4f55\u5b89\u5168\u98ce\u9669\u3002"),(0,r.kt)("li",{parentName:"ul"},"\u7528",(0,r.kt)("inlineCode",{parentName:"li"},"Anchor"),"\u7684\u65b9\u6cd5\u6784\u5efa\u5668\u6765\u66ff\u6362\u590d\u6742\u7684",(0,r.kt)("inlineCode",{parentName:"li"},"UI"),"\u4ee3\u7801\u3002")),(0,r.kt)("p",null,"\u8fd9\u9879\u4efb\u52a1\u53ef\u80fd\u6709\u4e9b\u590d\u6742\uff0c\u9700\u8981\u4f60\u6295\u5165\u4e00\u4e9b\u65f6\u95f4\u72ec\u7acb\u8fdb\u884c\u5c1d\u8bd5\u3002\u5982\u679c\u51e0\u4e2a\u5c0f\u65f6\u540e\u4f60\u611f\u5230\u56f0\u60d1\uff0c\u968f\u65f6\u53ef\u4ee5\u89c2\u770b\u6211\u4eec\u63d0\u4f9b\u7684\u89c6\u9891\u6f14\u793a\u89e3\u51b3\u65b9\u6848\u3002"),(0,r.kt)("p",null,"\u6211\u4eec\u6765\u5171\u540c\u5b8c\u6210\u8fd9\u4e2a\u4efb\u52a1\uff0c\u5e76\u67e5\u770b\u6211\u4eec\u7684\u6210\u679c\u3002\u6211\u4eec\u4e0d\u662f\u5728\u589e\u52a0\u65b0\u529f\u80fd\uff0c\u800c\u662f\u8981\u5b8c\u5168\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor"),"\u66ff\u6362\u6211\u4eec\u4e00\u76f4\u5728\u52aa\u529b\u5f00\u53d1\u7684\u8d28\u62bc\u8ba1\u5212\u3002"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u901a\u8fc7\u8fd0\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"anchor init anchor-nft-staking")," \u521b\u5efa\u4e00\u4e2a\u65b0\u9879\u76ee\uff0c\u6216\u8005\u53ef\u4ee5\u9009\u62e9\u81ea\u5df1\u7684\u540d\u5b57\u3002\u7136\u540e\u6253\u5f00 ",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor.toml")," \u6587\u4ef6\uff0c\u5c06\u79cd\u5b50\u8bbe\u7f6e\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"true"),"\uff0c\u96c6\u7fa4\u8bbe\u7f6e\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"devnet"),"\u3002"),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\uff0c\u8df3\u8f6c\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"/programs/anchor-nft-staking/Cargo.toml"),"\uff0c\u5e76\u6dfb\u52a0\u4ee5\u4e0b\u4f9d\u8d56\u9879\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-toml"},'anchor-lang = { version="0.25.0", features = ["init-if-needed"] }\nanchor-spl = "0.25.0"\nmpl-token-metadata = { version="1.4.1", features=["no-entrypoint"] }\n')),(0,r.kt)("p",null,"\u597d\u7684\uff0c\u6253\u5f00 ",(0,r.kt)("inlineCode",{parentName:"p"},"lib.rs")," \u6587\u4ef6\uff0c\u6211\u4eec\u6765\u6784\u5efa\u57fa\u672c\u7684\u6846\u67b6\u3002"),(0,r.kt)("p",null,"\u6211\u4eec\u9700\u8981\u6dfb\u52a0\u4ee5\u4e0b\u5bfc\u5165\u3002\u968f\u7740\u6211\u4eec\u7684\u5de5\u4f5c\u8fdb\u5c55\uff0c\u6bcf\u4e2a\u5bfc\u5165\u7684\u5fc5\u8981\u6027\u5c06\u9010\u6e10\u663e\u73b0\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"use anchor_lang::solana_program::program::invoke_signed;\nuse anchor_spl::token;\nuse anchor_spl::{\n    associated_token::AssociatedToken,\n    token::{Approve, Mint, MintTo, Revoke, Token, TokenAccount},\n};\nuse mpl_token_metadata::{\n    instruction::{freeze_delegated_account, thaw_delegated_account},\n    ID as MetadataTokenId,\n};\n")),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u6211\u4eec\u5c06\u9ed8\u8ba4\u51fd\u6570\u7684\u540d\u79f0\u66f4\u6539\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"stake"),"\uff0c\u5e76\u66f4\u6539\u5176\u76f8\u5173\u4e0a\u4e0b\u6587\u4e3a\u7c7b\u578b",(0,r.kt)("inlineCode",{parentName:"p"},"Stake"),"\u3002"),(0,r.kt)("p",null,"\u7136\u540e\u6dfb\u52a0\u540d\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"redeem")," \u7684\u51fd\u6570\uff0c\u4e0a\u4e0b\u6587\u7c7b\u578b\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"Redeem"),"\u3002"),(0,r.kt)("p",null,"\u6700\u540e\uff0c\u5bf9\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"unstake"),"\uff0c\u4f7f\u7528\u4e0a\u4e0b\u6587\u7c7b\u578b ",(0,r.kt)("inlineCode",{parentName:"p"},"Unstake")," \u8fdb\u884c\u76f8\u540c\u64cd\u4f5c\u3002"),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\u6211\u4eec\u8981\u6784\u5efa\u7684\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"Stake"),"\u7684\u7ed3\u6784\u3002\u6211\u4eec\u9700\u8981\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"PDA"),"\u6765\u5b58\u50a8",(0,r.kt)("inlineCode",{parentName:"p"},"UserStakeInfo"),"\uff0c\u5e76\u4e14\u9700\u8981\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"StakeState"),"\u679a\u4e3e\u6765\u8868\u793a",(0,r.kt)("inlineCode",{parentName:"p"},"PDA"),"\u7684\u5176\u4e2d\u4e00\u4e2a\u5b57\u6bb5\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"#[account]\npub struct UserStakeInfo {\n    pub token_account: Pubkey,\n    pub stake_start_time: i64,\n    pub last_stake_redeem: i64,\n    pub user_pubkey: Pubkey,\n    pub stake_state: StakeState,\n    pub is_initialized: bool,\n}\n\n#[derive(Debug, PartialEq, AnchorDeserialize, AnchorSerialize, Clone)]\npub enum StakeState {\n    Unstaked,\n    Staked,\n}\n")),(0,r.kt)("p",null,"\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"StakeState"),"\u6dfb\u52a0\u4e00\u4e2a\u9ed8\u8ba4\u503c\uff0c\u8bbe\u4e3a\u672a\u62b5\u62bc\u72b6\u6001\u3002"),(0,r.kt)("p",null,"\u7531\u4e8e\u6211\u4eec\u5c06\u4f7f\u7528\u7684\u5143\u6570\u636e\u7a0b\u5e8f\u76f8\u5bf9\u8f83\u65b0\uff0c\u951a\u5b9a\u7a0b\u5e8f\u4e2d\u8fd8\u6ca1\u6709\u76f8\u5e94\u7684\u7c7b\u578b\u3002\u4e3a\u4e86\u50cf\u5176\u4ed6\u7a0b\u5e8f\uff08\u4f8b\u5982\u7cfb\u7edf\u7a0b\u5e8f\u3001\u4ee4\u724c\u7a0b\u5e8f\u7b49\uff09\u4e00\u6837\u4f7f\u7528\u5b83\uff0c\u6211\u4eec\u5c06\u4e3a\u5176\u521b\u5efa\u4e00\u4e2a\u7ed3\u6784\u4f53\uff0c\u5e76\u6dfb\u52a0\u4e00\u4e2a\u540d\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},"id")," \u7684\u5b9e\u73b0\uff0c\u8fd4\u56de\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"Pubkey"),"\uff0c\u5b83\u5bf9\u5e94\u4e8e ",(0,r.kt)("inlineCode",{parentName:"p"},"MetadataTokenId"),"\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"#[derive(Clone)]\npub struct Metadata;\n\nimpl anchor_lang::Id for Metadata {\n    fn id() -> Pubkey {\n        MetadataTokenId\n    }\n}\n")),(0,r.kt)("p",null,"\u597d\u7684\uff0c\u73b0\u5728\u6211\u4eec\u53ef\u4ee5\u5f00\u59cb\u5904\u7406\u8d28\u62bc\u90e8\u5206\u3002\u4e0b\u9762\u662f\u7ed3\u6784\u4f53\u6240\u9700\u7684\u4e5d\u4e2a\u8d26\u6237\uff0c\u4ee5\u53ca\u4e00\u4e9b\u503c\u5f97\u6ce8\u610f\u7684\u4e8b\u9879\u3002"),(0,r.kt)("p",null,"\u9996\u5148\uff0c\u4f60\u4f1a\u770b\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"nft_edition")," \u662f\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"Unchecked")," \u8d26\u6237\uff0c\u8fd9\u662f\u56e0\u4e3a\u7cfb\u7edf\u4e2d\u8fd8\u672a\u4e3a\u8fd9\u79cd\u7c7b\u578b\u7684\u8d26\u6237\u521b\u5efa\u3002\u6240\u6709\u672a\u7ecf\u6838\u5b9e\u7684\u8d26\u6237\u90fd\u9700\u9644\u5e26\u4e00\u6761\u5907\u6ce8\uff0c\u4ee5\u4fbf\u7cfb\u7edf\u77e5\u9053\u4f60\u5c06\u8fdb\u884c\u624b\u52a8\u5b89\u5168\u68c0\u67e5\u3002\u4f60\u4f1a\u5728\u4e0b\u65b9\u770b\u5230 ",(0,r.kt)("inlineCode",{parentName:"p"},"CHECK: Manual validation"),"\u3002"),(0,r.kt)("p",null,"\u9700\u8981\u63d0\u9192\u7684\u662f\uff0c\u6bcf\u4e2a\u8d26\u6237\u4e0a\u7684\u5c5e\u6027\u90fd\u662f\u4e00\u79cd\u5b89\u5168\u68c0\u67e5\uff0c\u4ee5\u786e\u4fdd\u8d26\u6237\u662f\u6b63\u786e\u7684\u7c7b\u578b\u5e76\u80fd\u6267\u884c\u7279\u5b9a\u529f\u80fd\u3002\u7531\u4e8e\u7528\u6237\u9700\u8981\u4ed8\u8d39\uff0c\u5e76\u4e14",(0,r.kt)("inlineCode",{parentName:"p"},"NFT"),"\u4ee3\u5e01\u8d26\u6237\u5c06\u88ab\u4fee\u6539\uff0c\u6240\u4ee5\u4e24\u8005\u90fd\u5177\u6709",(0,r.kt)("inlineCode",{parentName:"p"},"mut"),"\u5c5e\u6027\u3002\u67d0\u4e9b\u8d26\u6237\u8fd8\u9700\u8981\u79cd\u5b50\uff0c\u5982\u4e0b\u6240\u793a\u3002"),(0,r.kt)("p",null,"\u81f3\u4e8e\u5176\u4ed6\u6ca1\u6709\u4efb\u4f55\u5c5e\u6027\u7684\u8d26\u6237\uff0c\u5b83\u4eec\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor"),"\u4e2d\u90fd\u6709\u81ea\u5df1\u5fc5\u9700\u7684\u5b89\u5168\u68c0\u67e5\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u9700\u8981\u6dfb\u52a0\u4efb\u4f55\u5c5e\u6027\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"#[derive(Accounts)]\npub struct Stake<'info> {\n    #[account(mut)]\n    pub user: Signer<'info>,\n    #[account(\n        mut,\n        associated_token::mint=nft_mint,\n        associated_token::authority=user\n    )]\n    pub nft_token_account: Account<'info, TokenAccount>,\n    pub nft_mint: Account<'info, Mint>,\n    /// CHECK: Manual validation\n    #[account(owner=MetadataTokenId)]\n    pub nft_edition: UncheckedAccount<'info>,\n    #[account(\n        init_if_needed,\n        payer=user,\n        space = std::mem::size_of::<UserStakeInfo>() + 8,\n        seeds = [user.key().as_ref(), nft_token_account.key().as_ref()],\n        bump\n    )]\n    pub stake_state: Account<'info, UserStakeInfo>,\n    /// CHECK: Manual validation\n    #[account(mut, seeds=[\"authority\".as_bytes().as_ref()], bump)]\n    pub program_authority: UncheckedAccount<'info>,\n    pub token_program: Program<'info, Token>,\n    pub system_program: Program<'info, System>,\n    pub metadata_program: Program<'info, Metadata>,\n}\n")),(0,r.kt)("p",null,"\u5728\u7ee7\u7eed\u64cd\u4f5c\u4e4b\u524d\uff0c\u5148\u8fd0\u884c",(0,r.kt)("inlineCode",{parentName:"p"},"anchor build"),"\uff0c\u8fd9\u6837\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u6784\u5efa\u5c31\u53ef\u4ee5\u5f00\u59cb\u4e86\u3002\u8bf7\u8bb0\u4f4f\uff0c\u8fd9\u662f\u6211\u4eec\u7684\u7b2c\u4e00\u6b21\u6784\u5efa\uff0c\u5b83\u4f1a\u751f\u6210\u6211\u4eec\u7684\u7a0b\u5e8f",(0,r.kt)("inlineCode",{parentName:"p"},"ID"),"\u3002"),(0,r.kt)("p",null,"\u5728\u6784\u5efa\u7684\u540c\u65f6\uff0c\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"tests"),"\u76ee\u5f55\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"utils"),"\u7684\u65b0\u6587\u4ef6\u5939\u3002\u5728\u5176\u4e2d\u521b\u5efa\u4e00\u4e2a\u540d\u4e3a",(0,r.kt)("inlineCode",{parentName:"p"},"setupNft.ts"),"\u7684\u6587\u4ef6\uff0c\u5e76\u5c06\u4e0b\u9762\u7684\u4ee3\u7801\u7c98\u8d34\u8fdb\u53bb\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'import {\n  bundlrStorage,\n  keypairIdentity,\n  Metaplex,\n} from "@metaplex-foundation/js"\nimport { createMint, getAssociatedTokenAddress } from "@solana/spl-token"\nimport * as anchor from "@project-serum/anchor"\n\nexport const setupNft = async (program, payer) => {\n  const metaplex = Metaplex.make(program.provider.connection)\n    .use(keypairIdentity(payer))\n    .use(bundlrStorage())\n\n  const nft = await metaplex\n    .nfts()\n    .create({\n      uri: "",\n      name: "Test nft",\n      sellerFeeBasisPoints: 0,\n    })\n\n  console.log("nft metadata pubkey: ", nft.metadataAddress.toBase58())\n  console.log("nft token address: ", nft.tokenAddress.toBase58())\n  const [delegatedAuthPda] = await anchor.web3.PublicKey.findProgramAddress(\n    [Buffer.from("authority")],\n    program.programId\n  )\n  const [stakeStatePda] = await anchor.web3.PublicKey.findProgramAddress(\n    [payer.publicKey.toBuffer(), nft.tokenAddress.toBuffer()],\n    program.programId\n  )\n\n  console.log("delegated authority pda: ", delegatedAuthPda.toBase58())\n  console.log("stake state pda: ", stakeStatePda.toBase58())\n  const [mintAuth] = await anchor.web3.PublicKey.findProgramAddress(\n    [Buffer.from("mint")],\n    program.programId\n  )\n\n  const mint = await createMint(\n    program.provider.connection,\n    payer,\n    mintAuth,\n    null,\n    2\n  )\n  console.log("Mint pubkey: ", mint.toBase58())\n\n  const tokenAddress = await getAssociatedTokenAddress(mint, payer.publicKey)\n\n  return {\n    nft: nft,\n    delegatedAuthPda: delegatedAuthPda,\n    stakeStatePda: stakeStatePda,\n    mint: mint,\n    mintAuth: mintAuth,\n    tokenAddress: tokenAddress,\n  }\n}\n\n')),(0,r.kt)("p",null,"\u7136\u540e\uff0c\u8fd0\u884c",(0,r.kt)("inlineCode",{parentName:"p"},"npm install @metaplex-foundation/js"),"\u3002"),(0,r.kt)("p",null,"\u6700\u540e\uff0c\u8f6c\u5230",(0,r.kt)("inlineCode",{parentName:"p"},"anchor-nft-staking.ts"),"\u76ee\u5f55\u3002\u8fd9\u662f",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor"),"\u521b\u5efa\u7684\u9ed8\u8ba4\u6587\u4ef6\u3002"),(0,r.kt)("p",null,"\u4f60\u9700\u8981\u5c06\u63d0\u4f9b\u8005\u7684\u9ed8\u8ba4\u884c\u5206\u4e3a\u4e24\u90e8\u5206\uff0c\u4ee5\u4fbf\u5728\u4ee5\u540e\u9700\u8981\u65f6\u80fd\u591f\u8bbf\u95ee\u63d0\u4f9b\u8005\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const provider = anchor.AnchorProvider.env();\nanchor.setProvider(provider);\n")),(0,r.kt)("p",null,"\u8ba9\u6211\u4eec\u5f15\u5165\u94b1\u5305\uff0c\u8fd9\u5c06\u4f7f\u6211\u4eec\u80fd\u591f\u516c\u5f00\u4ed8\u6b3e\u4eba\u4e3a\u4ea4\u6613\u7b7e\u540d\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"const wallet = anchor.workspace.AnchorNftStaking.provider.wallet;\n")),(0,r.kt)("p",null,"\u68c0\u67e5\u4f60\u7684\u7f16\u8bd1\u60c5\u51b5\uff0c\u5982\u679c\u4e00\u5207\u987a\u5229\uff0c\u8bf7\u8fd0\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"anchor deploy"),"\u3002\u5982\u679c\u51fa\u73b0\u95ee\u9898\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u4e3a\u81ea\u5df1\u7a7a\u6295\u4e00\u4e9bSOL\u3002"),(0,r.kt)("p",null,"\u7f16\u8bd1\u5b8c\u6210\u540e\uff0c\u8fd0\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"anchor keys list")," \u5e76\u83b7\u53d6\u7a0b\u5e8f",(0,r.kt)("inlineCode",{parentName:"p"},"ID"),"\uff0c\u7136\u540e\u5c06\u5176\u653e\u5165 ",(0,r.kt)("inlineCode",{parentName:"p"},"lib.rs")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"Anchor.toml")," \u6587\u4ef6\u4e2d\u3002\u5982\u679c\u7f16\u8bd1\u82b1\u8d39\u4e00\u4e9b\u65f6\u95f4\uff0c\u4f60\u53ef\u80fd\u9700\u8981\u56de\u5230\u8fd9\u4e00\u6b65\u3002"),(0,r.kt)("p",null,"\u56de\u5230\u6d4b\u8bd5\u6587\u4ef6\u3002"),(0,r.kt)("p",null,"\u8ba9\u6211\u4eec\u5b9a\u4e49\u4e00\u4e9b\u6d4b\u8bd5\u4e2d\u9700\u8981\u4f7f\u7528\u7684\u53d8\u91cf\u7c7b\u578b\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"let delegatedAuthPda: anchor.web3.PublicKey;\nlet stakeStatePda: anchor.web3.PublicKey;\nlet nft: any;\nlet mintAuth: anchor.web3.PublicKey;\nlet mint: anchor.web3.PublicKey;\nlet tokenAddress: anchor.web3.PublicKey;\n")),(0,r.kt)("p",null,"\u73b0\u5728\uff0c\u6211\u4eec\u6dfb\u52a0\u4e00\u4e2a ",(0,r.kt)("inlineCode",{parentName:"p"},"before"),' \u51fd\u6570\uff0c\u8be5\u51fd\u6570\u4f1a\u5728\u6d4b\u8bd5\u8fd0\u884c\u4e4b\u524d\u88ab\u8c03\u7528\u3002\u6ce8\u610f"',(0,r.kt)("inlineCode",{parentName:"p"},";"),'"\u8bed\u6cd5\uff0c\u5b83\u4f1a\u89e3\u6784\u8fd4\u56de\u503c\u5e76\u4e3a\u6240\u6709\u8fd9\u4e9b\u503c\u8fdb\u884c\u8bbe\u7f6e\u3002'),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},"before(async () => {\n    ;({ nft, delegatedAuthPda, stakeStatePda, mint, mintAuth, tokenAddress } =\n      await setupNft(program, wallet.payer));\n  });\n")),(0,r.kt)("p",null,"\u8f6c\u5230\u9ed8\u8ba4\u6d4b\u8bd5\uff0c\u5c06\u5176\u66f4\u6539\u4e3a ",(0,r.kt)("inlineCode",{parentName:"p"},'it("Stakes"'),"\u3002\u9996\u5148\uff0c\u6211\u4eec\u53ea\u662f\u786e\u8ba4\u51fd\u6570\u88ab\u6210\u529f\u8c03\u7528\u3002\u6211\u4eec\u8fd8\u6ca1\u6709\u6784\u5efa\u5b9e\u9645\u7684\u62b5\u62bc\u51fd\u6570\uff0c\u6240\u4ee5\u6682\u65f6\u4e0d\u4f1a\u8fdb\u884c\u4efb\u4f55\u903b\u8f91\u6d4b\u8bd5\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'it("Stakes", async () => {\n    // \u5728\u6b64\u6dfb\u52a0\u4f60\u7684\u6d4b\u8bd5\u3002\n    await program.methods\n      .stake()\n      .accounts({\n        nftTokenAccount: nft.tokenAddress,\n        nftMint: nft.mintAddress,\n        nftEdition: nft.masterEditionAddress,\n        metadataProgram: METADATA_PROGRAM_ID,\n      })\n      .rpc();\n  });\n')),(0,r.kt)("p",null,"\u73b0\u5728\uff0c\u8fd0\u884c ",(0,r.kt)("inlineCode",{parentName:"p"},"anchor test"),"\u3002\u5982\u679c\u5b83\u901a\u8fc7\u4e86\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u901a\u8fc7\u4e86\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"Stake"),"\u7ed3\u6784\u4e2d\u521b\u5efa\u8d26\u6237\u7684\u9a8c\u8bc1\u3002"),(0,r.kt)("p",null,"\u56de\u5230\u903b\u8f91\u90e8\u5206\uff0c\u4e0b\u9762\u662f\u62b5\u62bc\u5de5\u4f5c\u6240\u9700\u7684\u9010\u6b65\u64cd\u4f5c\u3002\u6211\u4eec\u9700\u8981\u83b7\u53d6\u65f6\u949f\u8bbf\u95ee\u6743\u9650\uff0c\u786e\u4fdd\u62b5\u62bc\u72b6\u6001\u5df2\u521d\u59cb\u5316\uff0c\u5e76\u786e\u8ba4\u5c1a\u672a\u62b5\u62bc\u3002"),(0,r.kt)("p",null,"\u5728",(0,r.kt)("inlineCode",{parentName:"p"},"stake"),"\u51fd\u6570\u4e2d\uff0c\u6211\u4eec\u9996\u5148\u83b7\u53d6\u65f6\u949f\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"let clock = Clock::get().unwrap();\n")),(0,r.kt)("p",null,"\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u521b\u5efa\u4e00\u4e2a",(0,r.kt)("inlineCode",{parentName:"p"},"CPI"),"\u6765\u59d4\u6258\u8be5\u7a0b\u5e8f\u4f5c\u4e3a\u51bb\u7ed3\u6216\u89e3\u51bb\u6211\u4eec\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"NFT"),"\u7684\u6743\u9650\u3002\u9996\u5148\uff0c\u6211\u4eec\u8bbe\u7f6e",(0,r.kt)("inlineCode",{parentName:"p"},"CPI"),"\uff0c\u7136\u540e\u786e\u5b9a\u6211\u4eec\u8981\u4f7f\u7528\u7684\u8d26\u6237\uff0c\u6700\u540e\u8bbe\u5b9a\u6743\u9650\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'msg!("Approving delegate");\n\nlet cpi_approve_program = ctx.accounts.token_program.to_account_info();\nlet cpi_approve_accounts = Approve {\n    to: ctx.accounts.nft_token_account.to_account_info(),\n    delegate: ctx.accounts.program_authority.to_account_info(),\n    authority: ctx.accounts.user.to_account_info(),\n};\n\nlet cpi_approve_ctx = CpiContext::new(cpi_approve_program, cpi_approve_accounts);\ntoken::approve(cpi_approve_ctx, 1)?;\n')),(0,r.kt)("p",null,"\u7136\u540e\u6211\u4eec\u5f00\u59cb\u51bb\u7ed3\u4ee3\u5e01\u3002\u9996\u5148\u8bbe\u7f6e\u6743\u9650\u63d0\u5347\uff0c\u7136\u540e\u8c03\u7528",(0,r.kt)("inlineCode",{parentName:"p"},"invoke_signed"),"\u51fd\u6570\uff0c\u4f20\u5165\u6240\u6709\u5fc5\u8981\u7684\u8d26\u6237\u548c\u8d26\u6237\u4fe1\u606f\u6570\u7ec4\uff0c\u6700\u540e\u662f\u79cd\u5b50\u548c\u63d0\u5347\u503c\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'msg!("Freezing token account");\nlet authority_bump = *ctx.bumps.get("program_authority").unwrap();\ninvoke_signed(\n    &freeze_delegated_account(\n        ctx.accounts.metadata_program.key(),\n        ctx.accounts.program_authority.key(),\n        ctx.accounts.nft_token_account.key(),\n        ctx.accounts.nft_edition.key(),\n        ctx.accounts.nft_mint.key(),\n    ),\n    &[\n        ctx.accounts.program_authority.to_account_info(),\n        ctx.accounts.nft_token_account.to_account_info(),\n        ctx.accounts.nft_edition.to_account_info(),\n        ctx.accounts.nft_mint.to_account_info(),\n        ctx.accounts.metadata_program.to_account_info(),\n    ],\n    &[&[b"authority", &[authority_bump]]],\n)?;\n')),(0,r.kt)("p",null,"\u73b0\u5728\uff0c\u6211\u4eec\u5728\u80a1\u6743\u8d26\u6237\u4e0a\u8bbe\u7f6e\u6570\u636e\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"ctx.accounts.stake_state.token_account = ctx.accounts.nft_token_account.key();\nctx.accounts.stake_state.user_pubkey = ctx.accounts.user.key();\nctx.accounts.stake_state.stake_state = StakeState::Staked;\nctx.accounts.stake_state.stake_start_time = clock.unix_timestamp;\nctx.accounts.stake_state.last_stake_redeem = clock.unix_timestamp;\nctx.accounts.stake_state.is_initialized = true;\n")),(0,r.kt)("p",null,"\u54ce\u5440\uff0c\u8ba9\u6211\u4eec\u8df3\u5230\u6587\u4ef6\u5f00\u59cb\u90e8\u5206\u5e76\u6dfb\u52a0\u4e00\u4e2a\u5b89\u5168\u68c0\u67e5\uff0c\u6211\u4eec\u8fd8\u9700\u8981\u4e00\u4e2a\u81ea\u5b9a\u4e49\u9519\u8bef\u3002\u4e0b\u9762\u662f\u4e24\u6bb5\u4ee3\u7801\uff0c\u4f46\u662f\u5c06\u81ea\u5b9a\u4e49\u9519\u8bef\u4ee3\u7801\u653e\u5728\u6587\u4ef6\u5e95\u90e8\uff0c\u8fd9\u6837\u4e0d\u4f1a\u5f71\u54cd\u903b\u8f91\u548c\u7ed3\u6784\u7684\u9605\u8bfb\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},"require!(\n    ctx.accounts.stake_state.stake_state == StakeState::Unstaked,\n    StakeError::AlreadyStaked\n);\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-rust"},'#[error_code]\npub enum StakeError {\n    #[msg("NFT already staked")]\n    AlreadyStaked,\n}\n')),(0,r.kt)("p",null,"\u5728\u518d\u6b21\u6d4b\u8bd5\u4e4b\u524d\uff0c\u4e0d\u8981\u5fd8\u8bb0\u5145\u5b9e\u4f60\u7684",(0,r.kt)("inlineCode",{parentName:"p"},"SOL"),"\u4f59\u989d\u3002"),(0,r.kt)("p",null,"\u597d\u7684\uff0c\u5c31\u8fd9\u6837\uff0c\u8ba9\u6211\u4eec\u56de\u5230\u6d4b\u8bd5\u4e2d\uff0c\u4e3a\u6211\u4eec\u7684\u8d28\u62bc\u6d4b\u8bd5\u6dfb\u52a0\u4e00\u4e9b\u529f\u80fd\uff0c\u4ee5\u68c0\u67e5\u8d28\u62bc\u72b6\u6001\u662f\u5426\u6b63\u786e\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-ts"},'const account = await program.account.userStakeInfo.fetch(stakeStatePda);\nexpect(account.stakeState === "Staked");\n')),(0,r.kt)("p",null,"\u518d\u6b21\u8fd0\u884c\u6d4b\u8bd5\uff0c\u5e0c\u671b\u4e00\u5207\u90fd\u987a\u5229\uff01\ud83e\udd1e"),(0,r.kt)("p",null,"\u5c31\u8fd9\u6837\uff0c\u6211\u4eec\u7684\u7b2c\u4e00\u4e2a\u6307\u4ee4\u5df2\u7ecf\u843d\u5730\u751f\u6548\u3002\u5728\u63a5\u4e0b\u6765\u7684\u90e8\u5206\uff0c\u6211\u4eec\u5c06\u5904\u7406\u5176\u4f59\u4e24\u4e2a\u6307\u4ee4\uff0c\u7136\u540e\u7ec8\u4e8e\u5f00\u59cb\u5904\u7406\u5ba2\u6237\u7aef\u4ea4\u6613\u7684\u4e8b\u5b9c\u3002"))}d.isMDXComponent=!0}}]);